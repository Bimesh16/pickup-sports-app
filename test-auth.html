<!DOCTYPE html>
<html>
<head>
    <title>Test Authentication</title>
</head>
<body>
    <h1>Authentication Test</h1>
    <div id="status">Ready</div>
    <br>
    <button onclick="clearStorage()">Clear Browser Storage</button>
    <button onclick="testLogin()">Test Login</button>
    <button onclick="testGames()">Test Games API</button>
    <br><br>
    <div id="output"></div>

    <script>
        function log(message) {
            const output = document.getElementById('output');
            output.innerHTML += new Date().toISOString() + ': ' + message + '<br>';
        }

        function setStatus(message) {
            document.getElementById('status').textContent = message;
        }

        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            log('Browser storage cleared');
            setStatus('Storage cleared');
        }

        async function testLogin() {
            setStatus('Testing login...');
            try {
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        username: 'testuser', 
                        password: 'testpass' 
                    }),
                });

                if (response.ok) {
                    const data = await response.json();
                    log('Login successful: ' + JSON.stringify(data, null, 2));
                    setStatus('Login successful');
                } else {
                    const error = await response.text();
                    log('Login failed: ' + response.status + ' - ' + error);
                    setStatus('Login failed');
                }
            } catch (error) {
                log('Login error: ' + error.message);
                setStatus('Login error');
            }
        }

        async function testGames() {
            setStatus('Testing games API...');
            try {
                const token = localStorage.getItem('accessToken');
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

                const response = await fetch('/games', {
                    headers: headers
                });

                if (response.ok) {
                    const data = await response.json();
                    log('Games API successful: ' + JSON.stringify(data, null, 2));
                    setStatus('Games API successful');
                } else {
                    const error = await response.text();
                    log('Games API failed: ' + response.status + ' - ' + error);
                    setStatus('Games API failed');
                }
            } catch (error) {
                log('Games API error: ' + error.message);
                setStatus('Games API error');
            }
        }

        // Check what's in storage on load
        window.onload = function() {
            const accessToken = localStorage.getItem('accessToken');
            const refreshToken = localStorage.getItem('refreshToken');
            const nonce = localStorage.getItem('refreshNonce');
            
            if (accessToken || refreshToken || nonce) {
                log('Found tokens in storage:');
                log('- Access Token: ' + (accessToken ? 'Present' : 'None'));
                log('- Refresh Token: ' + (refreshToken ? 'Present' : 'None'));
                log('- Nonce: ' + (nonce ? 'Present' : 'None'));
            } else {
                log('No tokens found in browser storage');
            }
        };
    </script>
</body>
</html>
