<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Test</title>
    <!-- SockJS + classic STOMP v2 (works great with Spring) -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 16px; }
        #messages { border:1px solid #ccc; height:220px; overflow-y:auto; padding:8px; margin-bottom:8px; }
        #status { font-size:12px; color:#666; margin-bottom:8px; }
        #sendBtn[disabled] { opacity:.6; cursor:not-allowed; }
    </style>
</head>
<body>
<h3>Chat Tester</h3>
<div id="status">Connecting…</div>
<div id="messages"></div>
<input id="messageInput" type="text" placeholder="Type a message…" />
<button id="sendBtn" disabled>Send</button>

<script>
    // Use a real game id and your username/email
    const gameId   = 10;
    const username = 'denveruser@example.com';

    const status  = document.getElementById('status');
    const msgs    = document.getElementById('messages');
    const input   = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    function append(text) {
      const div = document.createElement('div');
      div.textContent = text;
      msgs.appendChild(div);
      msgs.scrollTop = msgs.scrollHeight;
    }

    // 1) Open SockJS to the same-origin endpoint
    const socket = new SockJS('/ws');

    // 2) Wrap with classic STOMP client
    const stompClient = Stomp.over(socket);
    // optional: reduce console noise
    // stompClient.debug = null;

    // 3) CONNECT (STOMP v1.1/1.2)
    stompClient.connect(
      {}, // no headers
      function onConnect(frame) {
        console.log('CONNECTED frame:', frame);
        status.textContent = 'Connected';
        sendBtn.disabled = false;

        stompClient.subscribe('/topic/games/' + gameId + '/chat', function (message) {
          const body = JSON.parse(message.body);
          append(body.sender + ': ' + body.content);
        });
      },
      function onError(error) {
        console.error('STOMP ERROR:', error);
        status.textContent = 'Disconnected: ' + (error && error.body ? error.body : error);
        sendBtn.disabled = true;
      }
    );

    // 4) Send message to @MessageMapping("/games/{gameId}/chat")
    sendBtn.addEventListener('click', function () {
      const content = input.value.trim();
      if (!content) return;
      stompClient.send('/app/games/' + gameId + '/chat', {}, JSON.stringify({
        gameId, sender: username, content
      }));
      input.value = '';
      input.focus();
    });
</script>
</body>
</html>
